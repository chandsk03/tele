<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Chat Rooms</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, system-ui, BlinkMacSystemFont, 'Segoe UI', Roboto, Ubuntu;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            margin: 0;
            padding: 10px;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .room-card {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button {
            background: var(--tg-theme-button-color, #2ea6ff);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Chat Rooms</h2>
        <div id="roomsList"></div>
        <button onclick="showCreateRoomModal()">Create New Room</button>
        <div id="modal" style="display: none;">
            <input type="text" id="roomName" placeholder="Room name">
            <button onclick="createRoom()">Create</button>
            <button onclick="hideModal()">Cancel</button>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let currentUser = null;

        // Initialize Web App
        tg.expand();
        tg.ready();

        // Get Telegram user data
        const initData = tg.initData;
        const user = tg.initDataUnsafe.user;

        // Authenticate user
        async function authenticate() {
            try {
                const response = await fetch('/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': initData
                    },
                    body: JSON.stringify({
                        user_id: user.id,
                        first_name: user.first_name,
                        last_name: user.last_name || ''
                    })
                });
                
                currentUser = await response.json();
                loadRooms();
            } catch (error) {
                console.error('Authentication failed:', error);
            }
        }

        // Load user's rooms
        async function loadRooms() {
            try {
                const response = await fetch(`/rooms?user_id=${currentUser.user_id}`);
                const rooms = await response.json();
                renderRooms(rooms);
            } catch (error) {
                console.error('Failed to load rooms:', error);
            }
        }

        // Render rooms list
        function renderRooms(rooms) {
            const container = document.getElementById('roomsList');
            container.innerHTML = rooms.map(room => `
                <div class="room-card">
                    <h3>${room.room_name}</h3>
                    <p>Members: ${room.members.length}</p>
                    ${room.created_by === currentUser.user_id ? 
                        `<button onclick="deleteRoom('${room.room_id}')">Delete</button>` : 
                        `<button onclick="exitRoom('${room.room_id}')">Exit</button>`}
                    <button onclick="shareRoom('${room.room_id}')">Share</button>
                </div>
            `).join('');
        }

        // Create room functionality
        async function createRoom() {
            const roomName = document.getElementById('roomName').value;
            try {
                await fetch('/create-room', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Telegram-Init-Data': initData
                    },
                    body: JSON.stringify({
                        room_name: roomName,
                        created_by: currentUser.user_id
                    })
                });
                loadRooms();
                hideModal();
            } catch (error) {
                console.error('Failed to create room:', error);
            }
        }

        // Share room using Telegram native sharing
        function shareRoom(roomId) {
            const inviteLink = `${window.location.origin}/join/${roomId}`;
            tg.showPopup({
                title: 'Invite Friends',
                message: `Share this link to invite others: ${inviteLink}`,
                buttons: [{
                    type: 'default',
                    text: 'Copy Link',
                    callback: () => navigator.clipboard.writeText(inviteLink)
                }]
            });
        }

        // Initialize app
        authenticate();
    </script>
</body>
</html>